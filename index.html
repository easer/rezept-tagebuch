<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>@rezept-tagebuch - Natalies Rezept Tagebuch</title>

    <!-- Zentrale CSS -->
    <link rel="stylesheet" href="/common/seaser-style.css?v=9">

    <!-- Google Font: Sacramento -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sacramento&display=swap" rel="stylesheet">

    <style>
        /* Prevent scroll bounce on iOS */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        body {
            position: relative;
        }

        .container {
            max-width: 1200px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-top: 220px; /* Platz für fixed header + tabs */
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Wichtig für Flex-Scrolling */
        }

        .search-category {
            padding: 16px 20px 8px;
        }

        .search-category-title {
            font-size: 0.85em;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .search-result {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .search-result:hover {
            background: rgba(255, 255, 255, 0.08);
            border-left-color: rgba(255, 255, 255, 0.4);
        }

        .search-result-title {
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .search-result-snippet {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.6);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-result-meta {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 4px;
        }

        .search-no-results {
            padding: 24px 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Überschrift mit Sacramento Font */
        header h1 {
            font-family: 'Sacramento', cursive;
            font-size: 3.5em;
            font-weight: 400;
            margin-bottom: 10px;
            text-align: center;
            white-space: nowrap;
            transform: rotate(-2deg);
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Macht die Schrift visuell fetter */
            -webkit-text-stroke: 0.5px currentColor;
            text-stroke: 0.5px currentColor;
            letter-spacing: 0.02em;
        }

        header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 1200px;
            text-align: center;
            padding: 65px 10px 20px 10px;
            background: linear-gradient(to bottom, rgba(20, 30, 40, 1) 0%, rgba(20, 30, 40, 0.95) 80%, transparent 100%);
            /* backdrop-filter entfernt - verursacht iOS Input-Focus Bug */
            z-index: 100;
            pointer-events: none; /* Header selbst nicht clickbar */
        }

        header h1 {
            pointer-events: auto; /* Nur Text ist clickbar falls nötig */
            margin-top: 10px; /* Titel weiter nach unten */
        }

        /* Responsive: iPhone 15 Pro Max (430px) */
        @media (max-width: 430px) {
            .container {
                padding-top: 200px; /* Angepasst für Header + Tabs */
            }

            header {
                padding: 60px 10px 8px 10px;
            }

            header h1 {
                font-size: 2.6em;
            }

            .tabs {
                top: 130px;
            }
        }

        /* Responsive: iPhone 13 Pro Max und kleiner (428px) */
        @media (max-width: 428px) {
            header h1 {
                font-size: 2.5em;
            }
        }

        /* Sehr kleine Bildschirme */
        @media (max-width: 380px) {
            header h1 {
                font-size: 2.1em;
            }
        }

        @media (max-width: 360px) {
            header h1 {
                font-size: 1.9em;
            }
        }

        /* Jedes Wort in eigener Pastellfarbe */
        .word-natalies {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC9D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(1px 1px 0 #FFB6C1)
                    drop-shadow(-1px -1px 0 #FFC9D6)
                    drop-shadow(1px -1px 0 #FFB6C1)
                    drop-shadow(-1px 1px 0 #FFC9D6)
                    drop-shadow(0 0 8px rgba(255, 182, 193, 0.5));
        }

        .word-rezept {
            background: linear-gradient(135deg, #E0BBE4 0%, #D5AAFF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(1px 1px 0 #E0BBE4)
                    drop-shadow(-1px -1px 0 #D5AAFF)
                    drop-shadow(1px -1px 0 #E0BBE4)
                    drop-shadow(-1px 1px 0 #D5AAFF)
                    drop-shadow(0 0 8px rgba(224, 187, 228, 0.5));
        }

        .word-tagebuch {
            background: linear-gradient(135deg, #AED9E0 0%, #C2E9FB 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(1px 1px 0 #AED9E0)
                    drop-shadow(-1px -1px 0 #C2E9FB)
                    drop-shadow(1px -1px 0 #AED9E0)
                    drop-shadow(-1px 1px 0 #C2E9FB)
                    drop-shadow(0 0 8px rgba(174, 217, 224, 0.5));
        }


        .search-bar {
            background: rgba(40, 50, 60, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: sticky;
            top: 0;
            z-index: 5;
            flex: 0 0 auto; /* Nicht wachsen/schrumpfen */
        }

        .controls {
            background: rgba(40, 50, 60, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 5;
            flex: 0 0 auto; /* Nicht wachsen/schrumpfen */
            flex-wrap: wrap;
            align-items: center;
        }

        .search-bar input,
        .controls input {
            background: rgba(50, 60, 70, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1em;
            flex: 1;
            min-width: 200px;
        }

        .controls input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .controls button {
            height: 28px;
            padding: 0 12px;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFD4E5 50%, #E0BBE4 100%);
            color: #4a4a4a;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
        }

        .controls button:hover {
            background: linear-gradient(135deg, #FFC1CC 0%, #FFE0EB 50%, #E8C4EC 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.6);
        }

        /* Tab Navigation */
        .tabs {
            position: fixed;
            top: 145px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 1160px;
            display: flex;
            gap: 10px;
            margin: 0;
            background: rgba(40, 50, 60, 0.95);
            /* backdrop-filter entfernt - verursacht iOS Input-Focus Bug */
            border-radius: 16px;
            padding: 8px;
            z-index: 99;
        }

        .tab {
            flex: 1;
            height: 28px;
            padding: 0 12px;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab:hover {
            color: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        /* Tab 1: Rezepte - Rosa/Pink */
        .tab:nth-child(1) {
            background: rgba(255, 182, 193, 0.3);
        }

        .tab:nth-child(1):hover {
            background: rgba(255, 182, 193, 0.4);
        }

        .tab:nth-child(1).active {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC9D6 100%);
            color: #4a4a4a;
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
        }

        /* Tab 2: TODOs - Grün */
        .tab:nth-child(2) {
            background: rgba(180, 231, 206, 0.3);
        }

        .tab:nth-child(2):hover {
            background: rgba(180, 231, 206, 0.4);
        }

        .tab:nth-child(2).active {
            background: linear-gradient(135deg, #B4E7CE 0%, #C9F4AA 100%);
            color: #2d5016;
            box-shadow: 0 4px 15px rgba(180, 231, 206, 0.4);
        }

        .tab-content {
            display: none;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 0;
        }

        .tab-content.active {
            display: flex;
            flex: 1;
            min-height: 0; /* Wichtig für Flex-Scrolling */
        }

        /* Floating Add Button für TODOs */
        .floating-add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFB5C0 0%, #FFC9D6 100%);
            border: none;
            box-shadow: 0 4px 20px rgba(255, 181, 192, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
            color: #8b3a46;
        }

        .floating-add-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 30px rgba(255, 181, 192, 0.7);
        }

        .floating-add-btn:active {
            transform: scale(0.95);
        }

        /* TODO Liste */
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .todo-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(50, 60, 70, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            overflow: hidden;
            height: 56px; /* Feste Höhe für alle Items */
            touch-action: pan-y; /* Ermöglicht vertikales Scrollen, horizontal für Swipe */
        }

        /* Pastellfarben für Prioritäten am linken Rand */
        .todo-item[data-priority="1"] {
            border-left: 4px solid #FFB5C0; /* Rosa Pastell */
        }

        .todo-item[data-priority="2"] {
            border-left: 4px solid #FFE66D; /* Gelb Pastell */
        }

        .todo-item[data-priority="3"] {
            border-left: 4px solid #AED9E0; /* Blau Pastell */
        }

        .todo-item:hover {
            background: rgba(60, 70, 80, 0.6);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Swipe-to-Delete Background */
        .todo-item::before {
            content: 'Löschen';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .todo-item.swiping::before {
            opacity: 1;
        }

        /* Swipe Content Wrapper */
        .todo-content {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            background: rgba(50, 60, 70, 0.5);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .todo-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            flex-shrink: 0;
            margin-top: 2px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .todo-checkbox:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
        }

        .todo-text {
            flex: 1;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95em;
            line-height: 1.4;
            /* Max 2 Zeilen mit Ellipsis */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 2.8em; /* 2 * line-height */
        }

        /* Rezepte Grid */
        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .recipe-card {
            background: rgba(40, 50, 60, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 14px;
            min-height: 70px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.3s;
        }

        .recipe-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .recipe-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .recipe-author-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .recipe-title {
            font-size: 0.95em;
            font-weight: 600;
            color: white;
            flex: 1;
        }

        .recipe-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .recipe-date {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8em;
            margin-bottom: 0;
        }

        .recipe-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .recipe-duration {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8em;
        }

        .recipe-rating {
            color: #F4E5A0;
            font-size: 0.95em;
        }

        .recipe-notes {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
            margin-top: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Auto-imported recipe badge */
        .recipe-card.auto-imported {
            border: 2px solid rgba(100, 200, 255, 0.4);
            background: rgba(40, 50, 60, 0.85);
        }

        .recipe-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: linear-gradient(135deg, rgba(100, 200, 255, 0.2) 0%, rgba(150, 220, 255, 0.2) 100%);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(100, 200, 255, 0.3);
        }

        .badge-icon {
            font-size: 1.1em;
        }

        .badge-text {
            color: rgba(150, 220, 255, 0.95);
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state .icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Slide-over Panel */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .slide-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height für iOS */
            width: 70%;
            max-width: 800px;
            background: rgba(30, 40, 50, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            box-shadow: -10px 0 60px rgba(0, 0, 0, 0.5);
            border-left: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow: hidden; /* Wichtig: kein scroll am Panel selbst */
            display: flex;
            flex-direction: column;
        }

        .slide-panel.active {
            transform: translateX(0);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 40, 50, 0.95);
            backdrop-filter: blur(40px);
            flex: 0 0 auto; /* Nie schrumpfen, nie wachsen */
        }

        .panel-header h2 {
            color: white;
            font-size: 1.8em;
            font-weight: 600;
            margin: 0;
        }

        .panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .panel-content {
            flex: 1 1 auto;
            padding: 30px;
            overflow-y: auto; /* Scroll nur hier */
            min-height: 0; /* Wichtig für Flex-Scroll */
            max-height: 100%; /* Verhindert Überlauf */
        }

        .panel-actions {
            padding: 10px 20px !important;
            padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 15px;
            background: rgba(30, 40, 50, 0.98);
            backdrop-filter: blur(20px);
            flex: 0 0 auto; /* Nie schrumpfen, nie wachsen */
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            min-height: 62px !important; /* 42px button + 2x10px padding */
            max-height: 82px !important; /* mit safe-area-inset max */
        }

        .panel-actions button {
            flex: 1;
            padding: 10px 20px !important;
            background: linear-gradient(135deg, #B4E7CE 0%, #C9F4AA 100%);
            color: #2d5016;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 42px !important;
            max-height: 42px !important;
            height: 42px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(180, 231, 206, 0.4);
        }

        .panel-actions button:hover {
            background: linear-gradient(135deg, #C0EDD7 0%, #D4F7B8 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(180, 231, 206, 0.6);
        }

        .panel-actions button.primary {
            background: linear-gradient(135deg, #AED9E0 0%, #B8E0D2 50%, #D6EADF 100%);
            color: #2c5f6f;
        }

        .panel-actions button.primary:hover {
            background: linear-gradient(135deg, #BAE0E7 0%, #C4E7D9 50%, #DFF0E5 100%);
        }

        .panel-actions button.danger {
            background: linear-gradient(135deg, #FFB3BA 0%, #FFDFBA 50%, #FFFFBA 100%);
            color: #8b3a3a;
        }

        .panel-actions button.danger:hover {
            background: linear-gradient(135deg, #FFC0C5 0%, #FFE7C5 50%, #FFFFC5 100%);
        }

        /* Detail View */
        .detail-row {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .detail-section {
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .detail-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
            min-width: 140px;
            flex-shrink: 0;
        }

        .detail-value {
            color: white;
            font-size: 1.1em;
            flex: 1;
        }

        /* Bilder in Detail-View: Label oben, mehr Abstand */
        .detail-row:has(img) {
            flex-direction: column;
            align-items: flex-start;
        }

        .detail-row:has(img) .detail-label {
            margin-bottom: 15px;
        }

        .detail-row:has(img) .detail-value {
            width: 100%;
        }

        .detail-row:has(img) .detail-value img {
            margin-bottom: 15px;
        }

        .detail-row:has(img) .detail-value img:last-child {
            margin-bottom: 0;
        }

        .detail-rating {
            color: #F4E5A0;
            font-size: 1.5em;
            flex: 1;
        }

        /* Detail-Sections mit komplexem Inhalt (Dokument, Bild, Notizen) */
        .detail-section.full-width {
            flex-direction: column;
            align-items: flex-start;
        }

        .detail-section.full-width .detail-label {
            margin-bottom: 8px;
        }

        /* Notizen Section - Label oben ausrichten */
        .detail-section.notes {
            flex-direction: column;
            align-items: stretch;
        }

        .detail-section.notes .detail-label {
            margin-bottom: 8px;
        }

        .detail-section.notes .detail-value {
            width: 100%;
        }

        /* Form-Gruppe mit Label oben (für Textareas) */
        .form-group.vertical {
            flex-direction: column;
            align-items: stretch;
        }

        .form-group.vertical label {
            min-width: 0;
            margin-bottom: 8px;
        }

        .form-group.vertical textarea {
            width: 100%;
            min-height: 120px;
        }

        /* Document/Image Viewer */
        .document-viewer {
            background: rgba(20, 30, 40, 0.8);
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .document-viewer iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
            background: white;
        }

        .document-viewer img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .document-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .document-info a {
            color: #4caf50;
            text-decoration: none;
        }

        .document-info a:hover {
            text-decoration: underline;
        }

        /* Form Styles */
        /* Form Layout: Label und Feld nebeneinander */
        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            white-space: nowrap;
            min-width: 140px;
            flex-shrink: 0;
        }

        /* Alle Formularfelder einheitliche Höhe (Referenz: Rezeptname) */
        .form-group input,
        .form-group select {
            flex: 1;
            min-width: 0; /* Wichtig für flex-shrinking */
            width: 100%;
            max-width: 100%;
            height: 44px; /* Feste Höhe wie Rezeptname-Feld */
            padding: 0 16px;
            background: rgba(50, 60, 70, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 1em;
            font-family: inherit;
            box-sizing: border-box;
        }

        /* Kalender-Icon verstecken */
        .form-group input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        .form-group input[type="date"]::-webkit-inner-spin-button {
            display: none;
        }

        .form-group input[type="file"] {
            height: 28px;
            max-width: 150px; /* Begrenzt auf Button-Breite */
            padding: 0;
            cursor: pointer;
            color: transparent;
            background: transparent;
            border: none;
            overflow: hidden; /* Versteckt Dateinamen-Überlauf */
        }

        .form-group input[type="file"]::file-selector-button {
            height: 28px;
            padding: 0 12px;
            background: linear-gradient(135deg, #FFDAC1 0%, #FFE5B4 100%);
            color: #8b6914;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            margin-right: 0; /* Kein Abstand rechts */
            box-shadow: 0 3px 10px rgba(255, 218, 193, 0.4);
        }

        .form-group input[type="file"]::file-selector-button:hover {
            background: linear-gradient(135deg, #FFE3CE 0%, #FFEEC2 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 218, 193, 0.6);
        }

        /* Spezial-Gruppen: Textarea und Datei-Upload */
        .form-group.textarea-group {
            align-items: flex-start;
            margin-bottom: 20px !important; /* Explizit für konsistenten Abstand */
        }

        .form-group.file-group {
            align-items: center;
            margin-bottom: 0; /* Kein extra Abstand - wird von #file-preview oder #pdf-status-row gehandhabt */
        }

        .form-group.file-group input[type="file"] {
            flex: 1;
            min-width: 0; /* Verhindert Überlauf */
            max-width: 100%; /* Verhindert dass es über den Rand ragt */
        }

        /* Image Preview als separate Zeile unter dem file-group */
        .image-preview {
            width: 100%;
        }

        .image-preview:not(:empty) {
            margin-bottom: 20px; /* Nur Abstand wenn Inhalt vorhanden */
        }

        /* PDF Status Row - Abstand oben */
        #pdf-status-row {
            margin-top: 20px;
        }

        .form-group textarea {
            flex: 1;
            min-height: 120px;
            padding: 12px 16px;
            background: rgba(50, 60, 70, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 1em;
            font-family: inherit;
            box-sizing: border-box;
            resize: vertical;
            margin: 0; /* Kein margin das den Abstand stören könnte */
        }

        /* Recipe Form nimmt ganzen verfügbaren Platz */
        #recipe-form {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Notizen-Gruppe stretch bis zum Ende */
        .form-group.textarea-group {
            flex: 1;
            min-height: 0;
            margin-bottom: 0; /* Kein Abstand am Ende */
        }

        .form-group.textarea-group textarea {
            height: 100%;
            min-height: 120px;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 1.3em; /* Verkleinert von 2em */
        }

        .star-rating .star {
            cursor: pointer;
            color: rgba(255, 255, 255, 0.3);
            transition: color 0.2s;
        }

        .star-rating .star.active {
            color: #F4E5A0;
        }

        .star-rating .star:hover {
            color: #F4E5A0;
        }

        /* Image Preview in Form */
        .image-preview {
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            max-height: 200px;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Confirm Dialog */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-content {
            background: rgba(40, 50, 60, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 20px;
            padding: 35px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-align: center;
        }

        .confirm-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
        }

        .confirm-title {
            color: white;
            font-size: 1.6em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .confirm-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1em;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .confirm-actions {
            display: flex;
            gap: 15px;
        }

        .confirm-actions button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #D5AAFF 0%, #E0BBE4 100%);
            color: #5a3a6d;
        }

        .btn-cancel:hover {
            background: linear-gradient(135deg, #DCBAFF 0%, #E8C4EC 100%);
            transform: scale(1.05);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FFB5C0 0%, #FFC9D6 100%);
            color: #8b3a46;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #FFC0CB 0%, #FFD4E0 100%);
            transform: scale(1.05);
        }

        /* Document Viewer Overlay */
        .document-viewer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .document-viewer-overlay.active {
            display: flex;
        }

        .document-viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: rgba(20, 30, 40, 0.98);
        }

        .document-viewer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            background: rgba(30, 40, 50, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            flex: 0 0 auto;
        }

        .document-viewer-header h3 {
            color: white;
            font-size: 1.5em;
            margin: 0;
        }

        .document-viewer-close {
            background: linear-gradient(135deg, #C2E9FB 0%, #A1C4FD 100%);
            color: #2c5a7d;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(161, 196, 253, 0.4);
        }

        .document-viewer-close:hover {
            background: linear-gradient(135deg, #CDEEFF 0%, #AED0FF 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(161, 196, 253, 0.6);
        }

        .document-viewer-content {
            flex: 1;
            overflow: hidden;
            display: flex;
        }

        .document-viewer-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .slide-panel {
                width: 100%;
                max-width: 100%;
            }

            .recipes-grid {
                grid-template-columns: 1fr;
            }

            .panel-content {
                padding: 20px;
            }

            .panel-header {
                padding: 20px;
            }

            .panel-actions {
                padding: 10px 20px !important;
                padding-bottom: max(10px, env(safe-area-inset-bottom)) !important; /* Notch-sicher */
                min-height: 62px !important; /* 42px button + 2x10px padding */
                max-height: 82px !important; /* mit safe-area-inset max */
            }

            .panel-actions button {
                padding: 10px 20px !important; /* Einheitliche Höhe mit allen anderen Buttons */
                font-size: 1.05em;
                min-height: 42px !important;
                max-height: 42px !important;
                height: 42px !important;
            }

            .document-viewer iframe {
                height: 400px;
            }
        }

        /* =================================================================
           PROFILE SELECTION SCREEN
           ================================================================= */
        .profile-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .profile-selection.hidden {
            display: none;
        }

        .profile-selection.fade-out {
            opacity: 0;
        }

        .profile-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-title {
            font-family: 'Sacramento', cursive;
            font-size: 3em;
            color: #667eea;
            margin: 0 0 10px 0;
            text-align: center;
        }

        .profile-subtitle {
            color: #666;
            text-align: center;
            margin: 0 0 30px 0;
            font-size: 0.95em;
        }

        .profile-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .profile-card {
            background: #f8f9fa;
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .profile-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .btn-new-profile,
        .btn-guest {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-new-profile {
            background: #667eea;
            color: white;
        }

        .btn-new-profile:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-guest {
            background: #e9ecef;
            color: #495057;
        }

        .btn-guest:hover {
            background: #dee2e6;
        }

        /* New Profile Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            margin: 0 0 20px 0;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-primary,
        .btn-secondary {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        /* User Info in Header */
        .user-info {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            z-index: 101; /* Höher als Header (100) */
            height: 48px;
            box-sizing: border-box;
        }

        .user-info.hidden {
            display: none;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .user-name {
            font-weight: 500;
            color: #333;
        }

        .btn-logout {
            background: #ffb3ba;
            color: #8b0000;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-logout:hover {
            background: #ff9a9f;
            color: #6b0000;
        }

        /* Version Badge & Refresh Button */
        .version-badge {
            position: fixed;
            top: 20px;
            right: 78px; /* Neben Refresh-Button (48px + 10px gap) */
            background: rgba(40, 50, 60, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 101; /* Gleiche Ebene wie user-info */
            cursor: default;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            height: 48px;
            box-sizing: border-box;
        }

        .version-badge:hover {
            background: rgba(40, 50, 60, 0.65);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }

        .version-badge svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .version-badge span {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85em;
            font-weight: 500;
            white-space: nowrap;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .refresh-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.4) 0%, rgba(255, 224, 235, 0.4) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101; /* Gleiche Ebene wie user-info und version-badge */
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 182, 193, 0.3);
        }

        .refresh-button:hover {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.6) 0%, rgba(255, 224, 235, 0.6) 100%);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(255, 182, 193, 0.5);
        }

        .refresh-button:active {
            transform: scale(0.95);
        }

        .refresh-button svg {
            width: 24px;
            height: 24px;
        }

        /* Search Toggle Button */
        .search-toggle-button {
            position: fixed;
            top: 20px;
            right: 170px; /* Links vom Version-Badge */
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(255, 248, 180, 0.4) 0%, rgba(255, 235, 153, 0.4) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 248, 180, 0.3);
        }

        .search-toggle-button:hover {
            background: linear-gradient(135deg, rgba(255, 248, 180, 0.6) 0%, rgba(255, 235, 153, 0.6) 100%);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(255, 248, 180, 0.5);
        }

        .search-toggle-button:active {
            transform: scale(0.95);
        }

        .search-toggle-button svg {
            width: 24px;
            height: 24px;
        }

        /* Search Panel */
        .search-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .search-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .search-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 90%;
            max-width: 450px;
            height: 100vh;
            background: rgba(30, 40, 50, 0.98);
            backdrop-filter: blur(40px);
            box-shadow: -10px 0 60px rgba(0, 0, 0, 0.5);
            border-left: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .search-panel.active {
            transform: translateX(0);
        }

        .search-panel-header {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .search-panel-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: white;
        }

        .panel-close-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .panel-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .panel-close-btn svg {
            width: 24px;
            height: 24px;
        }

        .search-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }

        #search-panel-input {
            width: 100%;
            background: rgba(50, 60, 70, 0.7);
            color: white;
            padding: 14px 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 17px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        #search-panel-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        #search-panel-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-results-container {
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .version-badge {
                right: 70px;
                padding: 6px 12px;
                gap: 6px;
                height: 44px;
            }

            .version-badge svg {
                width: 18px;
                height: 18px;
            }

            .version-badge span {
                font-size: 0.75em;
            }

            .refresh-button {
                width: 44px;
                height: 44px;
                top: 20px;
                right: 15px;
            }

            .refresh-button svg {
                width: 22px;
                height: 22px;
            }
        }

        @media (max-width: 768px) {
            .profile-container {
                padding: 20px 16px;
                max-height: 85vh;
            }

            .profile-title {
                font-size: 2em;
                margin: 0 0 5px 0;
            }

            .profile-subtitle {
                font-size: 0.85em;
                margin: 0 0 15px 0;
            }

            .profile-list {
                gap: 10px;
                margin-bottom: 15px;
            }

            .profile-card {
                padding: 15px 8px;
            }

            .profile-avatar {
                width: 50px;
                height: 50px;
                font-size: 24px;
                margin-bottom: 8px;
            }

            .profile-name {
                font-size: 0.85em;
            }

            .profile-actions {
                gap: 8px;
            }

            .btn-new-profile,
            .btn-guest {
                padding: 10px 16px;
                font-size: 0.95em;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-content h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .user-info {
                top: 20px;
                left: 15px;
                font-size: 0.9em;
                padding: 6px 12px;
                height: 44px;
            }

            .user-avatar-small {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .btn-logout {
                padding: 4px 10px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <!-- Profile Selection Screen -->
    <div id="profile-selection" class="profile-selection hidden">
        <div class="profile-container">
            <h1 class="profile-title">Wer bist du?</h1>
            <p class="profile-subtitle">Wähle dein Profil oder erstelle ein neues</p>

            <div id="profile-list" class="profile-list">
                <!-- Profiles werden hier dynamisch geladen -->
            </div>

            <div class="profile-actions">
                <button class="btn-new-profile" onclick="showNewProfileForm()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                    Neues Profil
                </button>
                <button class="btn-guest" onclick="loginAsGuest()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Als Gast fortfahren
                </button>
            </div>
        </div>
    </div>

    <!-- New Profile Modal -->
    <div id="new-profile-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Neues Profil erstellen</h2>
            <form id="new-profile-form" onsubmit="createNewProfile(event)">
                <div class="form-group">
                    <label for="new-profile-name">Name</label>
                    <input type="text" id="new-profile-name" required minlength="2" placeholder="z.B. Sarah">
                </div>
                <div class="form-group">
                    <label for="new-profile-email">Email (eindeutig)</label>
                    <input type="email" id="new-profile-email" required placeholder="sarah@seaser.local">
                </div>
                <div class="form-group">
                    <label>Farbe wählen</label>
                    <div class="color-picker">
                        <button type="button" class="color-option" data-color="#FFB6C1" style="background: #FFB6C1"></button>
                        <button type="button" class="color-option" data-color="#AED9E0" style="background: #AED9E0"></button>
                        <button type="button" class="color-option" data-color="#E0BBE4" style="background: #E0BBE4"></button>
                        <button type="button" class="color-option" data-color="#FFDFD3" style="background: #FFDFD3"></button>
                        <button type="button" class="color-option" data-color="#D4F1C5" style="background: #D4F1C5"></button>
                        <button type="button" class="color-option" data-color="#FFF4A3" style="background: #FFF4A3"></button>
                    </div>
                    <input type="hidden" id="new-profile-color" value="#AED9E0">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeNewProfileModal()">Abbrechen</button>
                    <button type="submit" class="btn-primary">Profil erstellen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Info (shown when logged in) -->
    <div id="user-info" class="user-info hidden">
        <div id="user-avatar-display" class="user-avatar-small"></div>
        <button class="btn-logout" onclick="logout()">Abmelden</button>
    </div>

    <!-- Version Badge -->
    <div class="version-badge" id="version-badge" title="Aktuelle Version">
        <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
        </svg>
        <span id="version-text">...</span>
    </div>

    <!-- Search Button -->
    <button class="search-toggle-button" onclick="toggleSearchPanel()" aria-label="Suche öffnen">
        <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
        </svg>
    </button>

    <!-- Refresh Button -->
    <button class="refresh-button" onclick="hardRefresh()" aria-label="Seite neu laden">
        <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255, 255, 255, 0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
    </button>

    <!-- Search Panel Backdrop -->
    <div id="search-backdrop" class="search-backdrop" onclick="closeSearchPanel()"></div>

    <!-- Search Panel -->
    <div id="search-panel" class="search-panel">
        <div class="search-panel-header">
            <h2>Suche</h2>
            <button onclick="closeSearchPanel()" class="panel-close-btn" aria-label="Schließen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="search-panel-content">
            <input type="text"
                   id="search-panel-input"
                   placeholder="Suchen..."
                   oninput="handleSearchPanelInput()"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false">
            <div id="search-panel-results" class="search-results-container"></div>
        </div>
    </div>

    <!-- Fixed Header außerhalb von container -->
    <header>
        <h1><span class="word-natalies">natalies</span> <span class="word-rezept">rezept</span> <span class="word-tagebuch">tagebuch</span></h1>
    </header>

    <!-- Fixed Tab Navigation außerhalb von container -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('tagebuch')">Tagebuch</button>
        <button class="tab" onclick="switchTab('rezepte')">Rezepte</button>
        <button class="tab" onclick="switchTab('todos')">TODOs</button>
    </div>

    <div class="container">
        <main>
            <!-- Tagebuch Tab -->
            <div id="tab-tagebuch" class="tab-content active">
                <!-- Tagebuch Liste -->
                <div id="diary-container" class="recipes-grid"></div>

                <!-- Empty State -->
                <div id="diary-empty-state" class="empty-state" style="display: none;">
                    <div class="icon">📔</div>
                    <h3>Noch keine Tagebucheinträge</h3>
                    <p>Füge deinen ersten Eintrag hinzu!</p>
                </div>
            </div>

            <!-- Rezepte Tab -->
            <div id="tab-rezepte" class="tab-content">
                <!-- Rezepte Grid -->
                <div id="recipes-container" class="recipes-grid"></div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="icon">🍳</div>
                    <h3>Noch keine Rezepte</h3>
                    <p>Füge dein erstes Rezept hinzu!</p>
                </div>
            </div>

            <!-- TODOs Tab -->
            <div id="tab-todos" class="tab-content">
                <!-- Alle TODOs -->
                <ul class="todo-list">
                    <!-- Wird dynamisch geladen -->
                </ul>
            </div>
        </main>

        <!-- Globaler Floating Add Button -->
        <button id="floating-add-btn" class="floating-add-btn" onclick="handleFloatingAdd()" aria-label="Hinzufügen">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>

    <!-- Panel Overlay -->
    <div class="panel-overlay" id="panel-overlay" onclick="closePanel()"></div>

    <!-- Slide-over Panel -->
    <div class="slide-panel" id="slide-panel">
        <div class="panel-header">
            <h2 id="panel-title">Rezept</h2>
            <button class="panel-close" onclick="closePanel()">&times;</button>
        </div>

        <div class="panel-content" id="panel-content">
            <!-- Content wird dynamisch geladen -->
        </div>

        <div class="panel-actions" id="panel-actions">
            <!-- Actions werden dynamisch geladen -->
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="confirm-dialog">
        <div class="confirm-content">
            <div class="confirm-icon">⚠️</div>
            <div class="confirm-title" id="confirm-title">Rezept löschen?</div>
            <div class="confirm-message" id="confirm-message">
                Diese Aktion kann nicht rückgängig gemacht werden.
            </div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirm()">Abbrechen</button>
                <button class="btn-danger" onclick="confirmDelete()">Löschen</button>
            </div>
        </div>
    </div>

    <!-- Document Viewer -->
    <div id="document-viewer-overlay" class="document-viewer-overlay">
        <div class="document-viewer-container">
            <div class="document-viewer-header">
                <h3 id="document-viewer-title">Dokument</h3>
                <button class="document-viewer-close" onclick="closeDocumentViewer()">← Zurück</button>
            </div>
            <div class="document-viewer-content">
                <iframe id="document-viewer-iframe" src=""></iframe>
            </div>
        </div>
    </div>

    <!-- TODO Dialog -->
    <div id="todo-dialog" class="confirm-dialog">
        <div class="confirm-content">
            <div class="confirm-title">Neues TODO</div>
            <div style="margin-bottom: 20px; flex: 1; display: flex; flex-direction: column;">
                <form id="todo-form" onsubmit="saveTodo(event)" style="display: flex; flex-direction: column; flex: 1;">
                    <div class="form-group" style="margin-bottom: 15px; flex: 1; display: flex; flex-direction: column;">
                        <textarea id="todo-text" required placeholder="Was möchtest du erledigen?" rows="8"
                               style="width: 100%; padding: 12px; background: rgba(50, 60, 70, 0.7); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; font-size: 1em; resize: vertical; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; flex: 1;"></textarea>
                    </div>
                    <div class="form-group">
                        <select id="todo-priority" required
                                style="width: 100%; padding: 12px; background: rgba(50, 60, 70, 0.7); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; font-size: 1em;">
                            <option value="1">Priorität I (Hoch)</option>
                            <option value="2" selected>Priorität II (Mittel)</option>
                            <option value="3">Priorität III (Niedrig)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeTodoDialog()">Abbrechen</button>
                <button class="btn-danger" style="background: linear-gradient(135deg, #B4E7CE 0%, #C9F4AA 100%); color: #2d5016;" onclick="document.getElementById('todo-form').requestSubmit()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'api';
        let recipes = [];
        let currentRecipeId = null;
        let deleteCallback = null;
        let panelMode = 'detail'; // 'detail' or 'edit'
        let currentUser = null; // {id, name, email, avatar_color} or {guest: true}

        // =================================================================
        // MULTI-USER FUNKTIONEN
        // =================================================================

        // Check if user is logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
                updateUserDisplay();
            } else {
                showProfileSelection();
            }
        }

        // Load all users for profile selection
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const users = await response.json();
                // Filter out test users (from pytest)
                const realUsers = users.filter(u => !u.email.includes('@test.local'));
                displayUserProfiles(realUsers);
            } catch (error) {
                console.error('Fehler beim Laden der User:', error);
            }
        }

        // Display user profiles in selection screen
        function displayUserProfiles(users) {
            const container = document.getElementById('profile-list');
            // Filter out system users (is_system flag or "Rezept Import" name)
            const regularUsers = users.filter(user => !user.is_system && user.name !== 'Rezept Import');
            container.innerHTML = regularUsers.map(user => `
                <div class="profile-card" onclick="selectUser(${user.id})">
                    <div class="profile-avatar" style="background: ${user.avatar_color}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="profile-name">${user.name}</div>
                </div>
            `).join('');
        }

        // Select a user profile
        async function selectUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`);
                const user = await response.json();
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));

                // Smooth fade-out transition
                const profileScreen = document.getElementById('profile-selection');
                profileScreen.classList.add('fade-out');
                setTimeout(() => {
                    showMainApp();
                    updateUserDisplay();
                }, 300);
            } catch (error) {
                console.error('Fehler beim Laden des Users:', error);
                alert('Fehler beim Anmelden');
            }
        }

        // Login as guest (read-only)
        function loginAsGuest() {
            currentUser = { guest: true, name: 'Gast', avatar_color: '#999' };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const profileScreen = document.getElementById('profile-selection');
            profileScreen.classList.add('fade-out');
            setTimeout(() => {
                showMainApp();
                updateUserDisplay();
            }, 300);
        }

        // Logout
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            location.reload();
        }

        // Show profile selection screen
        function showProfileSelection() {
            document.getElementById('profile-selection').classList.remove('hidden');
            loadUsers();
        }

        // Show main app
        function showMainApp() {
            document.getElementById('profile-selection').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
        }

        // Update user display in header
        function updateUserDisplay() {
            if (!currentUser) return;

            const avatarEl = document.getElementById('user-avatar-display');

            avatarEl.style.background = currentUser.avatar_color;
            avatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
            // Name wird nicht mehr angezeigt
        }

        // Show new profile form
        function showNewProfileForm() {
            document.getElementById('new-profile-modal').classList.remove('hidden');

            // Setup color picker
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('new-profile-color').value = this.dataset.color;
                });
            });

            // Select default color
            document.querySelector('.color-option[data-color="#AED9E0"]').classList.add('selected');
        }

        // Close new profile modal
        function closeNewProfileModal() {
            document.getElementById('new-profile-modal').classList.add('hidden');
            document.getElementById('new-profile-form').reset();
            document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
        }

        // Create new profile
        async function createNewProfile(event) {
            event.preventDefault();

            const name = document.getElementById('new-profile-name').value;
            const email = document.getElementById('new-profile-email').value;
            const color = document.getElementById('new-profile-color').value;

            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        avatar_color: color
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Fehler beim Erstellen');
                }

                const newUser = await response.json();
                closeNewProfileModal();
                await loadUsers();
                selectUser(newUser.id);
            } catch (error) {
                console.error('Fehler beim Erstellen:', error);
                alert(error.message || 'Fehler beim Erstellen des Profils');
            }
        }

        // Get user initial for avatar
        function getUserInitial(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        // =================================================================
        // MODIFIZIERTE INITIAL-FUNKTION
        // =================================================================

        // Version laden
        async function loadVersion() {
            try {
                const response = await fetch(`${API_BASE}/version`);
                const data = await response.json();
                const versionText = document.getElementById('version-text');

                if (data.version && data.version !== 'unknown') {
                    // Format: rezept_version_05_11_2025_001 -> v05.11.25-1
                    const match = data.version.match(/rezept_version_(\d{2})_(\d{2})_(\d{4})_(\d{3})/);
                    if (match) {
                        const [, day, month, year, build] = match;
                        const buildNum = parseInt(build, 10); // Remove leading zeros
                        versionText.textContent = `v${day}.${month}.${year.slice(-2)}-${buildNum}`;
                    } else {
                        versionText.textContent = data.version;
                    }
                    document.getElementById('version-badge').title = `Version: ${data.version}`;
                } else {
                    versionText.textContent = 'dev';
                    document.getElementById('version-badge').title = 'Development Version';
                }
            } catch (error) {
                console.log('Version konnte nicht geladen werden:', error);
                document.getElementById('version-text').textContent = 'dev';
            }
        }

        // Initial laden
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication first
            checkAuth();

            // Load version
            loadVersion();

            // Then load data
            loadRecipes();
            loadTodos();
            loadDiaryEntries();

            // Suche mit Debounce (Rezepte)
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadRecipes(e.target.value);
                }, 300);
            });

            // Suche mit Debounce (Tagebuch)
            let diarySearchTimeout;
            document.getElementById('diary-search-input').addEventListener('input', (e) => {
                clearTimeout(diarySearchTimeout);
                diarySearchTimeout = setTimeout(() => {
                    loadDiaryEntries(e.target.value);
                }, 300);
            });
        });

        // Statistiken laden (nicht mehr benötigt - Anzeige entfernt)
        async function loadStats() {
            // Funktion bleibt für Kompatibilität, macht aber nichts mehr
        }

        // Rezepte laden
        async function loadRecipes(search = '') {
            try {
                const url = search ? `${API_BASE}/recipes?search=${encodeURIComponent(search)}` : `${API_BASE}/recipes`;
                const response = await fetch(url);
                recipes = await response.json();
                renderRecipes();
            } catch (error) {
                console.error('Fehler beim Laden der Rezepte:', error);
            }
        }

        // Rezepte anzeigen
        function renderRecipes() {
            const container = document.getElementById('recipes-container');
            const emptyState = document.getElementById('empty-state');

            if (recipes.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = recipes.map(recipe => {
                const hasMeta = recipe.duration || recipe.rating;
                const userInitial = recipe.user_name ? recipe.user_name.charAt(0).toUpperCase() : 'N';
                const userColor = recipe.user_avatar_color || '#FFB6C1';
                const hasImage = recipe.image && recipe.image.trim() !== '';

                // Calculate days remaining for auto-imported recipes
                let daysRemaining = null;
                let isAutoImported = recipe.auto_imported === 1;
                if (isAutoImported && recipe.imported_at) {
                    const importedDate = new Date(recipe.imported_at);
                    const expiryDate = new Date(importedDate);
                    expiryDate.setDate(expiryDate.getDate() + 7);
                    const today = new Date();
                    const diffTime = expiryDate - today;
                    daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }

                return `
                <div class="recipe-card ${isAutoImported ? 'auto-imported' : ''}" onclick="showDetailPanel(${recipe.id})">
                    ${isAutoImported && daysRemaining !== null ? `
                        <div class="recipe-badge">
                            <span class="badge-icon">🌍</span>
                            <span class="badge-text">Noch ${daysRemaining} ${daysRemaining === 1 ? 'Tag' : 'Tage'} zum Nachkochen</span>
                        </div>
                    ` : ''}
                    <div class="recipe-header">
                        <div class="recipe-author-avatar" style="background: ${userColor}">${userInitial}</div>
                        <div class="recipe-title">${escapeHtml(recipe.title)}</div>
                        ${hasImage ? `<img src="${API_BASE}/uploads/${recipe.image}" class="recipe-thumbnail" alt="${escapeHtml(recipe.title)}">` : ''}
                    </div>
                    ${hasMeta ? `<div class="recipe-meta">
                        ${recipe.duration ? `<div class="recipe-duration">⏱️ ${formatDuration(recipe.duration)}</div>` : ''}
                        ${recipe.rating ? `<div class="recipe-rating">${'★'.repeat(recipe.rating)}${'☆'.repeat(5 - recipe.rating)}</div>` : ''}
                    </div>` : ''}
                </div>
                `;
            }).join('');
        }

        // Panel für neues Rezept öffnen
        function showAddPanel() {
            currentRecipeId = null;
            panelMode = 'edit';
            document.getElementById('panel-title').textContent = 'Neues Rezept';
            renderEditView();
            openPanel();
        }

        // Panel für Detail-Ansicht öffnen
        async function showDetailPanel(id) {
            currentRecipeId = id;
            panelMode = 'detail';
            document.getElementById('panel-title').textContent = 'Rezept';

            try {
                const response = await fetch(`${API_BASE}/recipes/${id}`);
                const recipe = await response.json();
                renderDetailView(recipe);
                openPanel();
            } catch (error) {
                console.error('Fehler beim Laden des Rezepts:', error);
                alert('Fehler beim Laden des Rezepts');
            }
        }

        // Panel für Edit-Ansicht öffnen
        async function showEditPanel(id = null) {
            currentRecipeId = id;
            panelMode = 'edit';

            if (id) {
                document.getElementById('panel-title').textContent = 'Rezept bearbeiten';
                try {
                    const response = await fetch(`${API_BASE}/recipes/${id}`);
                    const recipe = await response.json();
                    renderEditView(recipe);
                } catch (error) {
                    console.error('Fehler beim Laden des Rezepts:', error);
                    alert('Fehler beim Laden des Rezepts');
                }
            } else {
                document.getElementById('panel-title').textContent = 'Neues Rezept';
                renderEditView();
            }
        }

        // Detail-Ansicht rendern
        function renderDetailView(recipe) {
            const content = document.getElementById('panel-content');

            let documentHtml = '';
            if (recipe.image) {
                const fileExt = recipe.image.split('.').pop().toLowerCase();
                const isPdf = fileExt === 'pdf';
                const isDoc = ['doc', 'docx', 'odt', 'txt'].includes(fileExt);
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);

                if (isPdf || isDoc) {
                    documentHtml = `
                        <div class="detail-section">
                            <div class="detail-label">Rezept</div>
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                <input type="checkbox" checked disabled style="width: 20px; height: 20px; cursor: default;">
                                <button type="button" onclick="openDocumentViewer('${recipe.image}', '${escapeHtml(recipe.title)}')" style="width: 120px; background: linear-gradient(135deg, #A8E6CF 0%, #DCEDC8 100%); color: #2d5016; border: none; border-radius: 8px; padding: 0 12px; cursor: pointer; font-size: 0.9em; font-weight: 600; height: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 10px rgba(168, 230, 207, 0.4); transition: all 0.3s;">Öffnen</button>
                            </div>
                        </div>
                    `;
                } else if (isImage) {
                    documentHtml = `
                        <div class="detail-section full-width">
                            <div class="detail-label">Rezept</div>
                            <div class="document-viewer">
                                <img src="${API_BASE}/uploads/${recipe.image}" alt="${escapeHtml(recipe.title)}">
                            </div>
                        </div>
                    `;
                }
            }

            // Check if current user owns this recipe
            const isOwner = currentUser && !currentUser.guest && recipe.user_id === currentUser.id;

            content.innerHTML = `
                ${recipe.user_name ? `
                    <div class="detail-section">
                        <div class="detail-label">Erstellt von</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="recipe-author-avatar" style="background: ${recipe.user_avatar_color || '#FFB6C1'}">
                                ${recipe.user_name.charAt(0).toUpperCase()}
                            </div>
                            <span style="color: #D0D0D0; font-weight: 500;">${escapeHtml(recipe.user_name)}</span>
                        </div>
                    </div>
                ` : ''}

                <div class="detail-section">
                    <div class="detail-label">Rezept-Name</div>
                    <div class="detail-value">${escapeHtml(recipe.title)}</div>
                </div>

                ${recipe.duration ? `
                    <div class="detail-section">
                        <div class="detail-label">Zeitdauer</div>
                        <div class="detail-value">⏱️ ${formatDuration(recipe.duration)}</div>
                    </div>
                ` : ''}

                ${recipe.rating ? `
                    <div class="detail-section">
                        <div class="detail-label">Bewertung</div>
                        <div class="detail-rating">${'★'.repeat(recipe.rating)}${'☆'.repeat(5 - recipe.rating)}</div>
                    </div>
                ` : ''}

                ${documentHtml}

                ${recipe.notes ? `
                    <div class="detail-section notes">
                        <div class="detail-label">Notizen</div>
                        <div class="detail-value">${escapeHtml(recipe.notes)}</div>
                    </div>
                ` : ''}
            `;

            // Only show edit/delete for owner
            const actions = document.getElementById('panel-actions');
            if (isOwner) {
                actions.innerHTML = `
                    <button class="primary" onclick="showEditPanel(${recipe.id})">Bearbeiten</button>
                `;
            } else if (currentUser && currentUser.guest) {
                actions.innerHTML = `
                    <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; text-align: center; padding: 10px;">
                        Als Gast können Sie keine Rezepte bearbeiten
                    </div>
                `;
            } else {
                actions.innerHTML = `
                    <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; text-align: center; padding: 10px;">
                        Nur ${escapeHtml(recipe.user_name || 'der Ersteller')} kann dieses Rezept bearbeiten
                    </div>
                `;
            }
        }

        // Edit-Ansicht rendern
        function renderEditView(recipe = null) {
            const content = document.getElementById('panel-content');
            const isEdit = recipe !== null;

            content.innerHTML = `
                <form id="recipe-form" onsubmit="saveRecipe(event)">
                    <input type="hidden" id="recipe-id" value="${isEdit ? recipe.id : ''}">
                    <input type="hidden" id="recipe-image-filename" value="${isEdit && recipe.image ? recipe.image : ''}">

                    <div class="form-group">
                        <label for="recipe-title">REZEPT-NAME *</label>
                        <input type="text" id="recipe-title" required placeholder="z.B. Spaghetti Carbonara" value="${isEdit ? escapeHtml(recipe.title) : ''}">
                    </div>

                    <div class="form-group">
                        <label for="recipe-duration">ZEITDAUER</label>
                        <select id="recipe-duration">
                            <option value="">Keine Angabe</option>
                            <option value="0.25" ${isEdit && recipe.duration == 0.25 ? 'selected' : ''}>15 Minuten</option>
                            <option value="0.5" ${isEdit && recipe.duration == 0.5 ? 'selected' : ''}>30 Minuten</option>
                            <option value="0.75" ${isEdit && recipe.duration == 0.75 ? 'selected' : ''}>45 Minuten</option>
                            <option value="1" ${isEdit && recipe.duration == 1 ? 'selected' : ''}>1 Stunde</option>
                            <option value="1.25" ${isEdit && recipe.duration == 1.25 ? 'selected' : ''}>1 Std. 15 Min.</option>
                            <option value="1.5" ${isEdit && recipe.duration == 1.5 ? 'selected' : ''}>1 Std. 30 Min.</option>
                            <option value="1.75" ${isEdit && recipe.duration == 1.75 ? 'selected' : ''}>1 Std. 45 Min.</option>
                            <option value="2" ${isEdit && recipe.duration == 2 ? 'selected' : ''}>2 Stunden</option>
                            <option value="2.5" ${isEdit && recipe.duration == 2.5 ? 'selected' : ''}>2 Std. 30 Min.</option>
                            <option value="3" ${isEdit && recipe.duration == 3 ? 'selected' : ''}>3 Stunden</option>
                            <option value="3.5" ${isEdit && recipe.duration == 3.5 ? 'selected' : ''}>3 Std. 30 Min.</option>
                            <option value="4" ${isEdit && recipe.duration == 4 ? 'selected' : ''}>4 Stunden</option>
                            <option value="5" ${isEdit && recipe.duration == 5 ? 'selected' : ''}>5 Stunden</option>
                            <option value="6" ${isEdit && recipe.duration == 6 ? 'selected' : ''}>6 Stunden</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>BEWERTUNG</label>
                        <input type="hidden" id="recipe-rating" value="${isEdit && recipe.rating ? recipe.rating : ''}">
                        <div class="star-rating" id="star-rating">
                            <span class="star ${isEdit && recipe.rating >= 1 ? 'active' : ''}" data-value="1">★</span>
                            <span class="star ${isEdit && recipe.rating >= 2 ? 'active' : ''}" data-value="2">★</span>
                            <span class="star ${isEdit && recipe.rating >= 3 ? 'active' : ''}" data-value="3">★</span>
                            <span class="star ${isEdit && recipe.rating >= 4 ? 'active' : ''}" data-value="4">★</span>
                            <span class="star ${isEdit && recipe.rating >= 5 ? 'active' : ''}" data-value="5">★</span>
                        </div>
                    </div>

                    <div class="form-group file-group">
                        <label for="recipe-image">UPLOADER</label>
                        <input type="file" id="recipe-image" accept="image/*,.pdf,.doc,.docx,.odt,.txt" onchange="previewFile(event)">
                    </div>

                    <div id="file-preview" class="image-preview">
                        ${isEdit && recipe.image ? renderFilePreview(recipe.image, recipe.title) : ''}
                    </div>

                    <div class="form-group" id="pdf-status-row">
                        <label>REZEPT</label>
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <input type="checkbox" id="pdf-checkbox" disabled style="width: 20px; height: 20px; cursor: default;">
                            <button type="button" id="pdf-open-btn" onclick="openCurrentPDF()" disabled style="flex: 1; background: linear-gradient(135deg, #FFE66D 0%, #FFF59D 100%); color: #6d5c00; border: none; border-radius: 8px; padding: 0 12px; cursor: pointer; font-size: 0.9em; font-weight: 600; height: 28px; display: flex; align-items: center; justify-content: center; opacity: 0.5; box-shadow: 0 3px 10px rgba(255, 230, 109, 0.4); transition: all 0.3s;">Öffnen</button>
                            <button type="button" id="pdf-delete-btn" onclick="removeFile()" disabled style="flex: 1; background: linear-gradient(135deg, #FFB5D8 0%, #FFC9E5 100%); color: #8b3a5a; border: none; border-radius: 8px; padding: 0 12px; cursor: pointer; font-size: 0.9em; font-weight: 600; height: 28px; display: flex; align-items: center; justify-content: center; opacity: 0.5; box-shadow: 0 3px 10px rgba(255, 181, 216, 0.4); transition: all 0.3s;">Löschen</button>
                        </div>
                    </div>

                    <div class="form-group vertical">
                        <label for="recipe-notes">NOTIZEN</label>
                        <textarea id="recipe-notes" placeholder="Besonderheiten, Variationen, persönliche Anmerkungen...">${isEdit && recipe.notes ? escapeHtml(recipe.notes) : ''}</textarea>
                    </div>
                </form>
            `;

            // Star rating initialisieren
            setTimeout(() => {
                initStarRating();

                // PDF-Status initialisieren falls bereits eine Datei vorhanden ist
                // Warten bis DOM-Elemente sicher verfügbar sind
                setTimeout(() => {
                    if (isEdit && recipe.image) {
                        const fileExt = recipe.image.split('.').pop().toLowerCase();
                        const isPdfOrDoc = ['pdf', 'doc', 'docx', 'odt', 'txt'].includes(fileExt);
                        if (isPdfOrDoc) {
                            updatePDFStatus(true, recipe.image, recipe.title);
                        } else {
                            updatePDFStatus(false);
                        }
                    } else {
                        updatePDFStatus(false);
                    }
                }, 10);
            }, 0);

            const actions = document.getElementById('panel-actions');
            actions.innerHTML = `
                <button class="primary" onclick="document.getElementById('recipe-form').requestSubmit()">Speichern</button>
                ${isEdit ? '<button class="danger" onclick="deleteRecipe()">Löschen</button>' : ''}
            `;
        }

        // File Preview rendern
        function renderFilePreview(filename, title) {
            const fileExt = filename.split('.').pop().toLowerCase();
            const isPdf = fileExt === 'pdf';
            const isDoc = ['doc', 'docx', 'odt', 'txt'].includes(fileExt);
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);

            if (isImage) {
                return `
                    <div style="position: relative;">
                        <img src="${API_BASE}/uploads/${filename}" alt="${escapeHtml(title)}">
                        <button type="button" onclick="removeFile()" style="position: absolute; top: 5px; right: 5px; background: linear-gradient(135deg, #FFABAB 0%, #FFC3A0 100%); color: #8b3a3a; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; box-shadow: 0 3px 10px rgba(255, 171, 171, 0.5); transition: all 0.3s;">×</button>
                    </div>
                `;
            } else if (isPdf || isDoc) {
                // PDF-Status-Row aktivieren
                updatePDFStatus(true, filename, title);
                return ''; // Kein separates Preview-Element mehr
            }
            return '';
        }

        // PDF-Status aktualisieren
        let currentPDFFilename = '';
        let currentPDFTitle = '';

        function updatePDFStatus(hasPDF, filename = '', title = '') {
            const checkbox = document.getElementById('pdf-checkbox');
            const openBtn = document.getElementById('pdf-open-btn');
            const deleteBtn = document.getElementById('pdf-delete-btn');

            // Elemente existieren nicht in allen Views (nur in Edit)
            if (!checkbox || !openBtn || !deleteBtn) {
                console.log('PDF-Status Elemente nicht gefunden');
                return;
            }

            console.log('updatePDFStatus:', hasPDF, filename);

            if (hasPDF) {
                checkbox.checked = true;
                openBtn.disabled = false;
                deleteBtn.disabled = false;
                openBtn.style.opacity = '1';
                openBtn.style.cursor = 'pointer';
                deleteBtn.style.opacity = '1';
                deleteBtn.style.cursor = 'pointer';
                currentPDFFilename = filename;
                currentPDFTitle = title;
            } else {
                checkbox.checked = false;
                openBtn.disabled = true;
                deleteBtn.disabled = true;
                openBtn.style.opacity = '0.5';
                openBtn.style.cursor = 'not-allowed';
                deleteBtn.style.opacity = '0.5';
                deleteBtn.style.cursor = 'not-allowed';
                currentPDFFilename = '';
                currentPDFTitle = '';
            }
        }

        function openCurrentPDF() {
            if (currentPDFFilename) {
                openDocumentViewer(currentPDFFilename, currentPDFTitle);
            }
        }

        // Datei-Vorschau
        async function previewFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExt = file.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
            const isPdf = fileExt === 'pdf';
            const isDoc = ['doc', 'docx', 'odt', 'txt'].includes(fileExt);

            // Lokale Vorschau für Bilder (mit X-Button zum Entfernen)
            if (isImage) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('file-preview').innerHTML = `
                        <div style="position: relative;">
                            <img src="${e.target.result}" alt="Vorschau">
                            <button type="button" onclick="removeFile()" style="position: absolute; top: 5px; right: 5px; background: linear-gradient(135deg, #FFABAB 0%, #FFC3A0 100%); color: #8b3a3a; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; box-shadow: 0 3px 10px rgba(255, 171, 171, 0.5); transition: all 0.3s;">×</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (isPdf || isDoc) {
                // Für PDFs/Docs: Dateiname mit Öffnen & Löschen Buttons
                document.getElementById('file-preview').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(50, 60, 70, 0.5); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <span style="font-size: 1.5em;">📄</span>
                            <span style="color: rgba(255, 255, 255, 0.9);">${file.name}</span>
                        </div>
                        <button type="button" onclick="removeFile()" style="background: linear-gradient(135deg, #FFCCBC 0%, #FFE0B2 100%); color: #8b4513; border: none; border-radius: 10px; padding: 10px 16px; cursor: pointer; font-size: 0.95em; font-weight: 600; min-height: 42px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 204, 188, 0.4); transition: all 0.3s;">Löschen</button>
                    </div>
                `;
            }

            // Upload zum Server
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                document.getElementById('recipe-image-filename').value = data.filename;

                // Für PDFs: Nach Upload den "Öffnen"-Button hinzufügen
                if (isPdf || isDoc) {
                    document.getElementById('file-preview').innerHTML = `
                        <div style="padding: 12px; background: rgba(50, 60, 70, 0.5); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 1.5em;">📄</span>
                                <span style="color: rgba(255, 255, 255, 0.9);">PDF vorhanden</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" onclick="showDocumentViewer('${API_BASE}/uploads/${data.filename}', 'Dokument')" style="flex: 1; background: linear-gradient(135deg, #B4D4FF 0%, #C9E4DE 100%); color: #2c5a7d; border: none; border-radius: 10px; padding: 10px 16px; cursor: pointer; font-size: 0.95em; font-weight: 600; min-height: 42px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(180, 212, 255, 0.4); transition: all 0.3s;">Öffnen</button>
                                <button type="button" onclick="removeFile()" style="flex: 1; background: linear-gradient(135deg, #FFCCBC 0%, #FFE0B2 100%); color: #8b4513; border: none; border-radius: 10px; padding: 10px 16px; cursor: pointer; font-size: 0.95em; font-weight: 600; min-height: 42px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 204, 188, 0.4); transition: all 0.3s;">Löschen</button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Fehler beim Hochladen:', error);
                alert('Fehler beim Hochladen der Datei');
            }
        }

        // Datei entfernen
        function removeFile() {
            document.getElementById('recipe-image-filename').value = '';
            document.getElementById('recipe-image').value = '';
            document.getElementById('file-preview').innerHTML = '';
            updatePDFStatus(false); // PDF-Status zurücksetzen
        }

        // Sterne-Bewertung initialisieren
        function initStarRating() {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = this.getAttribute('data-value');
                    document.getElementById('recipe-rating').value = rating;
                    updateStarDisplay(rating);
                });
            });
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach(star => {
                const starValue = star.getAttribute('data-value');
                if (starValue <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // Rezept speichern
        async function saveRecipe(event) {
            event.preventDefault();

            // Prevent guests from creating/editing
            if (currentUser && currentUser.guest) {
                alert('Als Gast können Sie keine Rezepte erstellen oder bearbeiten');
                return;
            }

            const recipeData = {
                title: document.getElementById('recipe-title').value,
                image: document.getElementById('recipe-image-filename').value,
                notes: document.getElementById('recipe-notes').value,
                duration: document.getElementById('recipe-duration').value || null,
                rating: document.getElementById('recipe-rating').value || null,
                user_id: currentUser ? currentUser.id : 1  // Fallback to Natalie
            };

            try {
                let response;
                if (currentRecipeId) {
                    response = await fetch(`${API_BASE}/recipes/${currentRecipeId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(recipeData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/recipes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(recipeData)
                    });
                }

                if (response.ok) {
                    closePanel();
                    loadRecipes();
                    loadStats();
                } else {
                    alert('Fehler beim Speichern des Rezepts');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern des Rezepts');
            }
        }

        // Rezept löschen
        function deleteRecipe() {
            // Prevent guests from deleting
            if (currentUser && currentUser.guest) {
                alert('Als Gast können Sie keine Rezepte löschen');
                return;
            }

            showConfirm(
                'Rezept löschen?',
                'Diese Aktion kann nicht rückgängig gemacht werden.',
                async () => {
                    try {
                        const userId = currentUser ? currentUser.id : 1;
                        const response = await fetch(`${API_BASE}/recipes/${currentRecipeId}?user_id=${userId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            closePanel();
                            loadRecipes();
                            loadStats();
                        } else if (response.status === 403) {
                            alert('Sie können nur Ihre eigenen Rezepte löschen');
                        } else {
                            alert('Fehler beim Löschen des Rezepts');
                        }
                    } catch (error) {
                        console.error('Fehler beim Löschen:', error);
                        alert('Fehler beim Löschen des Rezepts');
                    }
                }
            );
        }

        // Panel öffnen/schließen
        function openPanel() {
            document.getElementById('panel-overlay').classList.add('active');
            document.getElementById('slide-panel').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePanel() {
            document.getElementById('panel-overlay').classList.remove('active');
            document.getElementById('slide-panel').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Confirm Dialog
        function showConfirm(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            deleteCallback = callback;
            document.getElementById('confirm-dialog').classList.add('active');
        }

        function closeConfirm() {
            document.getElementById('confirm-dialog').classList.remove('active');
            deleteCallback = null;
        }

        function confirmDelete() {
            if (deleteCallback) {
                deleteCallback();
            }
            closeConfirm();
        }

        // Hilfsfunktionen
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDuration(hours) {
            if (!hours) return '';
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            if (h === 0) return `${m} Min.`;
            if (m === 0) return `${h} Std.`;
            return `${h} Std. ${m} Min.`;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        // Document Viewer öffnen
        function showDocumentViewer(url, title) {
            document.getElementById('document-viewer-title').textContent = title;
            document.getElementById('document-viewer-iframe').src = url;
            document.getElementById('document-viewer-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Document Viewer öffnen
        function openDocumentViewer(filename, title) {
            document.getElementById('document-viewer-title').textContent = title || 'Dokument';
            document.getElementById('document-viewer-iframe').src = API_BASE + '/uploads/' + filename;
            document.getElementById('document-viewer-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Document Viewer schließen
        function closeDocumentViewer() {
            document.getElementById('document-viewer-overlay').classList.remove('active');
            document.getElementById('document-viewer-iframe').src = '';
            document.body.style.overflow = '';
        }

        // Aktueller Tab (global)
        let currentTab = 'tagebuch';

        // Tab-Wechsel
        function switchTab(tabName) {
            currentTab = tabName;

            // Alle Tabs deaktivieren
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Aktiven Tab aktivieren (FIX: Query by tabName, nicht event.target)
            document.querySelector(`[onclick*="switchTab('${tabName}')"]`)?.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Globaler Floating Add Button Handler
        function handleFloatingAdd() {
            switch(currentTab) {
                case 'tagebuch':
                    showAddDiaryPanel();
                    break;
                case 'rezepte':
                    showAddPanel();
                    break;
                case 'todos':
                    showAddTodoDialog();
                    break;
            }
        }

        // Search Panel Functions
        function toggleSearchPanel() {
            const panel = document.getElementById('search-panel');
            const backdrop = document.getElementById('search-backdrop');

            panel.classList.add('active');
            backdrop.classList.add('active');

            // Focus input after animation
            setTimeout(() => {
                document.getElementById('search-panel-input').focus();
            }, 300);
        }

        function closeSearchPanel() {
            const panel = document.getElementById('search-panel');
            const backdrop = document.getElementById('search-backdrop');
            const input = document.getElementById('search-panel-input');
            const results = document.getElementById('search-panel-results');

            panel.classList.remove('active');
            backdrop.classList.remove('active');

            // Clear search
            input.value = '';
            results.innerHTML = '';
        }

        // Search Panel Input Handler
        let searchPanelTimeout;
        async function handleSearchPanelInput() {
            const searchInput = document.getElementById('search-panel-input');
            const searchTerm = searchInput.value.trim();
            const resultsContainer = document.getElementById('search-panel-results');

            // Debounce
            clearTimeout(searchPanelTimeout);

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            searchPanelTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(searchTerm)}`);
                    const data = await response.json();

                    renderSearchPanelResults(data);
                } catch (error) {
                    console.error('Search error:', error);
                    resultsContainer.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 20px;">Fehler bei der Suche</div>';
                }
            }, 300);
        }

        function renderSearchPanelResults(data) {
            const container = document.getElementById('search-panel-results');
            const hasResults = data.recipes.length > 0 || data.diary_entries.length > 0 || data.todos.length > 0;

            if (!hasResults) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 20px;">Keine Ergebnisse gefunden</div>';
                return;
            }

            let html = '';

            // Rezepte
            if (data.recipes.length > 0) {
                html += '<div class="search-category">';
                html += '<div class="search-category-title">Rezepte</div>';
                data.recipes.forEach(recipe => {
                    html += `
                        <div class="search-result" onclick="openRecipeFromSearchPanel(${recipe.id})">
                            <div class="search-result-title">${escapeHtml(recipe.title)}</div>
                            ${recipe.snippet ? `<div class="search-result-snippet">${escapeHtml(recipe.snippet)}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Tagebuch-Einträge
            if (data.diary_entries.length > 0) {
                html += '<div class="search-category">';
                html += '<div class="search-category-title">Tagebuch</div>';
                data.diary_entries.forEach(entry => {
                    const date = new Date(entry.created_at);
                    const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    html += `
                        <div class="search-result" onclick="openDiaryEntryFromSearchPanel(${entry.id})">
                            <div class="search-result-title">${escapeHtml(entry.recipe_title)}</div>
                            ${entry.snippet ? `<div class="search-result-snippet">${escapeHtml(entry.snippet)}</div>` : ''}
                            <div class="search-result-meta">${dateStr}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // TODOs
            if (data.todos.length > 0) {
                html += '<div class="search-category">';
                html += '<div class="search-category-title">TODOs</div>';
                data.todos.forEach(todo => {
                    html += `
                        <div class="search-result" onclick="openTodoFromSearchPanel(${todo.id})">
                            <div class="search-result-snippet">${escapeHtml(todo.text)}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Click-Handler für Search Panel Results
        async function openRecipeFromSearchPanel(recipeId) {
            closeSearchPanel();
            switchTab('rezepte');
            await new Promise(resolve => setTimeout(resolve, 100));
            showDetailPanel(recipeId);
        }

        async function openDiaryEntryFromSearchPanel(entryId) {
            closeSearchPanel();
            switchTab('tagebuch');
            await new Promise(resolve => setTimeout(resolve, 100));
            showEditDiaryPanel(entryId);
        }

        async function openTodoFromSearchPanel(todoId) {
            closeSearchPanel();
            switchTab('todos');
            await new Promise(resolve => setTimeout(resolve, 100));
            await loadTodos();
        }

        // Globale Suche Handler mit Dropdown
        let searchTimeout;
        async function handleGlobalSearch() {
            const searchInput = document.getElementById('global-search-input');
            const searchTerm = searchInput.value.trim();
            const dropdown = document.getElementById('search-dropdown');

            // Debounce: Warte 300ms nach letzter Eingabe
            clearTimeout(searchTimeout);

            if (searchTerm.length < 2) {
                dropdown.classList.remove('active');
                dropdown.innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(searchTerm)}`);
                    const data = await response.json();

                    renderSearchResults(data);
                } catch (error) {
                    console.error('Search error:', error);
                    dropdown.classList.remove('active');
                }
            }, 300);
        }

        function renderSearchResults(data) {
            const dropdown = document.getElementById('search-dropdown');
            const hasResults = data.recipes.length > 0 || data.diary_entries.length > 0 || data.todos.length > 0;

            if (!hasResults) {
                dropdown.innerHTML = '<div class="search-no-results">Keine Ergebnisse gefunden</div>';
                dropdown.classList.add('active');
                return;
            }

            let html = '';

            // Rezepte
            if (data.recipes.length > 0) {
                html += '<div class="search-category">';
                html += '<div class="search-category-title">Rezepte</div>';
                data.recipes.forEach(recipe => {
                    html += `
                        <div class="search-result" onclick="openRecipeFromSearch(${recipe.id})">
                            <div class="search-result-title">${escapeHtml(recipe.title)}</div>
                            ${recipe.snippet ? `<div class="search-result-snippet">${escapeHtml(recipe.snippet)}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Tagebuch-Einträge
            if (data.diary_entries.length > 0) {
                html += '<div class="search-category">';
                html += '<div class="search-category-title">Tagebuch</div>';
                data.diary_entries.forEach(entry => {
                    const date = new Date(entry.created_at);
                    const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    html += `
                        <div class="search-result" onclick="openDiaryEntryFromSearch(${entry.id})">
                            <div class="search-result-title">${escapeHtml(entry.recipe_title)}</div>
                            ${entry.snippet ? `<div class="search-result-snippet">${escapeHtml(entry.snippet)}</div>` : ''}
                            <div class="search-result-meta">${dateStr}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // TODOs
            if (data.todos.length > 0) {
                html += '<div class="search-category">';
                html += '<div class="search-category-title">TODOs</div>';
                data.todos.forEach(todo => {
                    html += `
                        <div class="search-result" onclick="openTodoFromSearch(${todo.id})">
                            <div class="search-result-snippet">${escapeHtml(todo.text)}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.add('active');
        }

        // Helper: HTML escaping
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Click-Handler: Rezept öffnen
        async function openRecipeFromSearch(recipeId) {
            closeSearchDropdown();
            switchTab('rezepte');

            // Warte kurz bis Tab gewechselt ist
            await new Promise(resolve => setTimeout(resolve, 100));

            // Öffne Detail-Panel mit Recipe-ID
            showDetailPanel(recipeId);
        }

        // Click-Handler: Tagebuch-Eintrag öffnen
        async function openDiaryEntryFromSearch(entryId) {
            closeSearchDropdown();
            switchTab('tagebuch');

            await new Promise(resolve => setTimeout(resolve, 100));

            // Öffne Edit-Panel mit Entry-ID
            showEditDiaryPanel(entryId);
        }

        // Click-Handler: TODO öffnen
        async function openTodoFromSearch(todoId) {
            closeSearchDropdown();
            switchTab('todos');

            await new Promise(resolve => setTimeout(resolve, 100));

            // Lade TODO und fokussiere es
            await loadTodos();
            // TODO-Item hervorheben könnte man später noch implementieren
        }

        // Dropdown schließen
        function closeSearchDropdown() {
            const dropdown = document.getElementById('search-dropdown');
            dropdown.classList.remove('active');
            document.getElementById('global-search-input').value = '';
        }

        // Dropdown schließen bei Klick außerhalb
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.global-search');
            if (searchContainer && !searchContainer.contains(e.target)) {
                closeSearchDropdown();
            }
        });

        // TODOs filtern
        function filterTodos(searchTerm) {
            if (!searchTerm.trim()) {
                renderTodos(allTodos);
                return;
            }

            const filtered = allTodos.filter(todo =>
                todo.text.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderTodos(filtered);
        }

        // TODOs State
        let allTodos = [];

        // TODOs laden
        async function loadTodos() {
            try {
                const response = await fetch(`${API_BASE}/todos`);
                allTodos = await response.json();
                renderTodos(allTodos);
            } catch (error) {
                console.error('Fehler beim Laden der TODOs:', error);
            }
        }

        // TODOs anzeigen
        function renderTodos(todos) {
            // Nach Priorität sortieren (1 = höchste zuerst)
            const sortedTodos = [...todos].sort((a, b) => a.priority - b.priority);

            const list = document.querySelector('.todo-list');
            if (!list) return;

            list.innerHTML = sortedTodos.map(todo => `
                <li class="todo-item" data-todo-id="${todo.id}" data-priority="${todo.priority}">
                    <div class="todo-content">
                        <div class="todo-checkbox ${todo.completed ? 'checked' : ''}"
                             onclick="event.stopPropagation(); toggleTodo(${todo.id})"
                             style="${todo.completed ? 'background: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.6);' : ''}">
                            ${todo.completed ? '✓' : ''}
                        </div>
                        <div class="todo-text" onclick="openTodoDetail(${todo.id})" style="${todo.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''} cursor: pointer;">${escapeHtml(todo.text)}</div>
                    </div>
                </li>
            `).join('');

            // Swipe-to-Delete initialisieren für alle TODO-Items
            list.querySelectorAll('.todo-item').forEach(item => {
                initSwipeToDelete(item);
            });
        }

        // TODO Toggle
        async function toggleTodo(id) {
            try {
                const todo = allTodos.find(t => t.id === id);
                if (!todo) return;

                const response = await fetch(`${API_BASE}/todos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: todo.text,
                        priority: todo.priority,
                        completed: todo.completed ? 0 : 1
                    })
                });
                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Fehler beim Aktualisieren des TODOs:', error);
            }
        }

        // TODO Detail-Ansicht öffnen
        async function openTodoDetail(id) {
            try {
                const response = await fetch(`${API_BASE}/todos/${id}`);
                const todo = await response.json();

                // Panel-Titel setzen
                document.getElementById('panel-title').textContent = 'TODO Details';

                // Content
                const content = document.getElementById('panel-content');
                const priorityLabels = {
                    1: 'Priorität I (Hoch)',
                    2: 'Priorität II (Mittel)',
                    3: 'Priorität III (Niedrig)'
                };

                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-bottom: 8px;">Beschreibung</label>
                        <textarea id="edit-todo-text"
                                  style="width: 100%; padding: 12px; background: rgba(50, 60, 70, 0.7); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; font-size: 1em; resize: vertical; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; min-height: 150px;">${escapeHtml(todo.text)}</textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-bottom: 8px;">Priorität</label>
                        <select id="edit-todo-priority"
                                style="width: 100%; padding: 12px; background: rgba(50, 60, 70, 0.7); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; font-size: 1em;">
                            <option value="1" ${todo.priority === 1 ? 'selected' : ''}>Priorität I (Hoch)</option>
                            <option value="2" ${todo.priority === 2 ? 'selected' : ''}>Priorität II (Mittel)</option>
                            <option value="3" ${todo.priority === 3 ? 'selected' : ''}>Priorität III (Niedrig)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin-bottom: 8px;">Status</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="edit-todo-completed" ${todo.completed ? 'checked' : ''}
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="edit-todo-completed" style="color: white; cursor: pointer;">Erledigt</label>
                        </div>
                    </div>
                    <div style="color: rgba(255, 255, 255, 0.4); font-size: 0.85em;">
                        Erstellt: ${new Date(todo.created_at).toLocaleString('de-DE')}<br>
                        Aktualisiert: ${new Date(todo.updated_at).toLocaleString('de-DE')}
                    </div>
                `;

                // Actions
                const actions = document.getElementById('panel-actions');
                actions.innerHTML = `
                    <button onclick="updateTodo(${id})" class="btn-primary">Speichern</button>
                    <button onclick="deleteTodoFromPanel(${id})" class="btn-danger">Löschen</button>
                `;

                openPanel();
            } catch (error) {
                console.error('Fehler beim Laden des TODOs:', error);
                alert('Fehler beim Laden des TODOs');
            }
        }

        // TODO aus Panel aktualisieren
        async function updateTodo(id) {
            const text = document.getElementById('edit-todo-text').value;
            const priority = parseInt(document.getElementById('edit-todo-priority').value);
            const completed = document.getElementById('edit-todo-completed').checked ? 1 : 0;

            try {
                const response = await fetch(`${API_BASE}/todos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text, priority, completed})
                });

                if (response.ok) {
                    closePanel();
                    loadTodos();
                } else {
                    alert('Fehler beim Speichern des TODOs');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern des TODOs');
            }
        }

        // TODO aus Panel löschen
        async function deleteTodoFromPanel(id) {
            if (!confirm('Möchtest du dieses TODO wirklich löschen?')) return;

            try {
                const response = await fetch(`${API_BASE}/todos/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closePanel();
                    loadTodos();
                } else {
                    alert('Fehler beim Löschen des TODOs');
                }
            } catch (error) {
                console.error('Fehler beim Löschen:', error);
                alert('Fehler beim Löschen des TODOs');
            }
        }

        // TODO Dialog öffnen
        function showAddTodoDialog() {
            document.getElementById('todo-text').value = '';
            document.getElementById('todo-priority').value = '2';
            document.getElementById('todo-dialog').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // TODO Dialog schließen
        function closeTodoDialog() {
            document.getElementById('todo-dialog').classList.remove('active');
            document.body.style.overflow = '';
        }

        // TODO speichern
        async function saveTodo(event) {
            event.preventDefault();
            const text = document.getElementById('todo-text').value;
            const priority = parseInt(document.getElementById('todo-priority').value);

            try {
                const response = await fetch(`${API_BASE}/todos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text, priority, completed: 0})
                });

                if (response.ok) {
                    closeTodoDialog();
                    loadTodos();
                } else {
                    alert('Fehler beim Speichern des TODOs');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern des TODOs');
            }
        }

        // Swipe-to-Delete initialisieren
        function initSwipeToDelete(item) {
            const content = item.querySelector('.todo-content');
            if (!content) return;

            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            let hasMoved = false; // Prüfen ob wirklich geswiped wurde
            const deleteThreshold = -100; // 100px nach links zum Löschen (höher für Sicherheit)
            const moveThreshold = 10; // Mindestens 10px Bewegung für Swipe

            // Touch Start
            const handleTouchStart = (e) => {
                startX = e.touches[0].clientX;
                currentX = startX; // Initialisiere currentX mit startX
                hasMoved = false;
                content.style.transition = 'none';
                isSwiping = true;
            };

            // Touch Move
            const handleTouchMove = (e) => {
                if (!isSwiping) return;

                currentX = e.touches[0].clientX;
                const diff = currentX - startX;

                // Prüfe ob signifikante Bewegung stattgefunden hat
                if (Math.abs(diff) > moveThreshold) {
                    hasMoved = true;
                }

                // Nur nach links swipen erlauben
                if (diff < 0) {
                    content.style.transform = `translateX(${diff}px)`;

                    // Visual Feedback wenn Delete-Threshold erreicht
                    if (diff <= deleteThreshold) {
                        item.classList.add('swiping');
                    } else {
                        item.classList.remove('swiping');
                    }
                }
            };

            // Touch End
            const handleTouchEnd = (e) => {
                if (!isSwiping) return;
                isSwiping = false;

                const diff = currentX - startX;
                content.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                // Nur löschen wenn wirklich geswiped wurde UND Threshold erreicht
                if (hasMoved && diff <= deleteThreshold) {
                    const todoId = parseInt(item.dataset.todoId);
                    deleteTodo(todoId);
                } else {
                    // Zurück zur Ausgangsposition
                    content.style.transform = 'translateX(0)';
                    item.classList.remove('swiping');
                }
            };

            // Mouse-Events für Desktop-Testing
            const handleMouseDown = (e) => {
                startX = e.clientX;
                currentX = startX; // Initialisiere currentX mit startX
                hasMoved = false;
                content.style.transition = 'none';
                isSwiping = true;
                e.preventDefault();
            };

            const handleMouseMove = (e) => {
                if (!isSwiping) return;

                currentX = e.clientX;
                const diff = currentX - startX;

                // Prüfe ob signifikante Bewegung stattgefunden hat
                if (Math.abs(diff) > moveThreshold) {
                    hasMoved = true;
                }

                if (diff < 0) {
                    content.style.transform = `translateX(${diff}px)`;

                    if (diff <= deleteThreshold) {
                        item.classList.add('swiping');
                    } else {
                        item.classList.remove('swiping');
                    }
                }
            };

            const handleMouseUp = (e) => {
                if (!isSwiping) return;
                isSwiping = false;

                const diff = currentX - startX;
                content.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                // Nur löschen wenn wirklich geswiped wurde UND Threshold erreicht
                if (hasMoved && diff <= deleteThreshold) {
                    const todoId = parseInt(item.dataset.todoId);
                    deleteTodo(todoId);
                } else {
                    content.style.transform = 'translateX(0)';
                    item.classList.remove('swiping');
                }
            };

            // Event Listeners
            content.addEventListener('touchstart', handleTouchStart, { passive: true });
            content.addEventListener('touchmove', handleTouchMove, { passive: true });
            content.addEventListener('touchend', handleTouchEnd);

            // Desktop Mouse Events (für Testing)
            content.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        // TODO löschen
        async function deleteTodo(id) {

            try {
                const response = await fetch(`${API_BASE}/todos/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadTodos();
                } else {
                    alert('Fehler beim Löschen des TODOs');
                }
            } catch (error) {
                console.error('Fehler beim Löschen:', error);
                alert('Fehler beim Löschen des TODOs');
            }
        }

        // === TAGEBUCH FUNKTIONEN ===

        // Tagebuch State
        let allDiaryEntries = [];
        let allRecipesForDiary = [];

        // Tagebuch laden
        async function loadDiaryEntries(search = '') {
            try {
                const url = search
                    ? `${API_BASE}/diary?search=${encodeURIComponent(search)}&t=${Date.now()}`
                    : `${API_BASE}/diary?t=${Date.now()}`;
                const response = await fetch(url);
                allDiaryEntries = await response.json();
                console.log('Loaded diary entries:', allDiaryEntries);
                renderDiaryEntries(allDiaryEntries);
            } catch (error) {
                console.error('Fehler beim Laden der Tagebucheinträge:', error);
            }
        }

        // Rezepte für Dropdown laden
        async function loadRecipesForDiary() {
            try {
                const response = await fetch(`${API_BASE}/recipes`);
                allRecipesForDiary = await response.json();
            } catch (error) {
                console.error('Fehler beim Laden der Rezepte:', error);
            }
        }

        // Tagebucheinträge anzeigen
        function renderDiaryEntries(entries) {
            const container = document.getElementById('diary-container');
            const emptyState = document.getElementById('diary-empty-state');

            if (entries.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = entries.map(entry => {
                const userInitial = entry.user_name ? entry.user_name.charAt(0).toUpperCase() : 'N';
                const userColor = entry.user_avatar_color || '#FFB6C1';
                // Parse images JSON array
                let firstImage = null;
                if (entry.images) {
                    try {
                        const images = JSON.parse(entry.images);
                        if (Array.isArray(images) && images.length > 0) {
                            firstImage = images[0];
                        }
                    } catch(e) {}
                }
                return `
                <div class="recipe-card" onclick="showDiaryDetail(${entry.id})">
                    <div class="recipe-header">
                        <div class="recipe-author-avatar" style="background: ${userColor}">${userInitial}</div>
                        <div class="recipe-title">${entry.dish_name || entry.recipe_title || 'Ohne Name'}</div>
                        ${firstImage ? `<img src="${API_BASE}/uploads/${firstImage}" class="recipe-thumbnail" alt="${entry.dish_name || entry.recipe_title || 'Ohne Name'}">` : ''}
                    </div>
                    <div class="recipe-date">${formatDate(entry.date)}</div>
                </div>
                `;
            }).join('');
        }

        // Datum formatieren
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('de-DE', options);
        }

        // Tagebuch-Detail anzeigen
        function showDiaryDetail(entryId) {
            const entry = allDiaryEntries.find(e => e.id === entryId);
            console.log('showDiaryDetail - entryId:', entryId);
            console.log('showDiaryDetail - entry:', entry);
            console.log('showDiaryDetail - entry.images:', entry?.images);
            if (!entry) return;

            const title = document.getElementById('panel-title');
            const content = document.getElementById('panel-content');
            const actions = document.getElementById('panel-actions');

            title.textContent = entry.dish_name || entry.recipe_title || 'Tagebucheintrag';

            content.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Datum</div>
                    <div class="detail-value">${formatDate(entry.date)}</div>
                </div>
                ${entry.notes ? `
                <div class="detail-row">
                    <div class="detail-label">Notizen</div>
                    <div class="detail-value">${entry.notes}</div>
                </div>
                ` : ''}
                ${entry.recipe_image ? `
                <div class="detail-row">
                    <div class="detail-label">Rezept</div>
                    <div class="detail-value">
                        ${entry.recipe_image.match(/\\.(pdf|doc|docx|odt|txt)$/i) ?
                            `<button onclick="window.open('${API_BASE}/uploads/${entry.recipe_image}', '_blank')" class="open-document-btn">📄 Rezept öffnen</button>` :
                            `<img src="${API_BASE}/uploads/${entry.recipe_image}?t=${Date.now()}" style="max-width: 100%; border-radius: 12px;" onerror="this.style.display='none'" />`
                        }
                    </div>
                </div>
                ` : ''}
                ${entry.images && entry.images.length > 0 ? `
                <div class="detail-row">
                    <div class="detail-label">Bilder</div>
                    <div class="detail-value">
                        ${entry.images.map(img => `<img src="${API_BASE}/uploads/${img}?t=${Date.now()}" style="max-width: 100%; border-radius: 12px;" onerror="this.style.display='none'" />`).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            actions.innerHTML = `
                <button onclick="showEditDiaryPanel(${entry.id})" class="btn-primary">Bearbeiten</button>
                <button onclick="deleteDiaryEntry(${entry.id})" class="btn-danger">Löschen</button>
            `;

            openPanel();
        }

        // Panel zum Hinzufügen eines neuen Eintrags anzeigen
        async function showAddDiaryPanel() {
            // Reset globale Variablen
            selectedDiaryImages = [];
            imagesToRemove = [];

            await loadRecipesForDiary();
            const title = document.getElementById('panel-title');
            const content = document.getElementById('panel-content');
            const actions = document.getElementById('panel-actions');

            title.textContent = 'Neuer Tagebucheintrag';

            content.innerHTML = `
                <form id="diary-form">
                    <div class="form-group">
                        <label>Rezept</label>
                        <select id="entry-recipe" onchange="updateDishName()">
                            <option value="">-- Ohne Rezept --</option>
                            ${allRecipesForDiary.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="entry-dish-name" placeholder="z.B. Züri Geschnetzeltes">
                    </div>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" id="entry-date" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group vertical">
                        <label>Notizen</label>
                        <textarea id="entry-notes" placeholder="Wie war das Essen? Besonderheiten?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bilder</label>
                        <input type="file" id="entry-images" multiple accept="image/*" onchange="previewDiaryImages(event)">
                    </div>
                    <small style="display: block; margin-top: -15px; margin-bottom: 15px; margin-left: 155px; color: rgba(255, 255, 255, 0.5);">Du kannst mehrere Bilder auswählen</small>
                    <div id="diary-images-preview" style="margin-left: 155px; margin-top: 10px; margin-bottom: 20px;"></div>
                </form>
            `;

            actions.innerHTML = `
                <button onclick="saveDiaryEntry()" class="btn-primary">Speichern</button>
            `;

            openPanel();
        }

        // Panel zum Bearbeiten eines Eintrags anzeigen
        async function showEditDiaryPanel(entryId) {
            // Reset globale Variablen
            selectedDiaryImages = [];
            imagesToRemove = [];

            await loadRecipesForDiary();
            const entry = allDiaryEntries.find(e => e.id === entryId);
            console.log('showEditDiaryPanel - entryId:', entryId);
            console.log('showEditDiaryPanel - entry:', entry);
            console.log('showEditDiaryPanel - entry.images:', entry?.images);
            if (!entry) return;

            const title = document.getElementById('panel-title');
            const content = document.getElementById('panel-content');
            const actions = document.getElementById('panel-actions');

            title.textContent = 'Tagebucheintrag bearbeiten';

            content.innerHTML = `
                <form id="diary-form">
                    <input type="hidden" id="entry-id" value="${entry.id}">
                    <div class="form-group">
                        <label>Rezept</label>
                        <select id="entry-recipe" onchange="updateDishName()">
                            <option value="">-- Ohne Rezept --</option>
                            ${allRecipesForDiary.map(r => `<option value="${r.id}" ${r.id === entry.recipe_id ? 'selected' : ''}>${r.title}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="entry-dish-name" value="${entry.dish_name || ''}" placeholder="z.B. Züri Geschnetzeltes">
                    </div>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" id="entry-date" value="${entry.date}" required>
                    </div>
                    <div class="form-group vertical">
                        <label>Notizen</label>
                        <textarea id="entry-notes">${entry.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Bilder</label>
                        <input type="file" id="entry-images" multiple accept="image/*" onchange="previewDiaryImages(event)">
                    </div>
                    <small style="display: block; margin-top: -15px; margin-bottom: 15px; margin-left: 155px; color: rgba(255, 255, 255, 0.5);">
                        ${entry.images && entry.images.length > 0 ? `Vorhandene: ${entry.images.length} | ` : ''}Neue Bilder hinzufügen
                    </small>
                    <div id="diary-images-preview" style="margin-left: 155px; margin-top: 10px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;">
                        ${entry.images && entry.images.length > 0 ? entry.images.map(img => `
                            <div style="position: relative; display: flex; align-items: center; background: rgba(50, 60, 70, 0.3); border-radius: 8px; padding: 8px; max-width: 300px;">
                                <img src="${API_BASE}/uploads/${img}" alt="Bild" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-right: 10px;">
                                <span style="flex: 1; color: rgba(255, 255, 255, 0.7); font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${img}</span>
                                <button type="button" onclick="removeExistingDiaryImage('${img}')" style="background: linear-gradient(135deg, #FFABAB 0%, #FFC3A0 100%); color: #8b3a3a; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1; box-shadow: 0 3px 10px rgba(255, 171, 171, 0.5); transition: all 0.3s; flex-shrink: 0;">×</button>
                            </div>
                        `).join('') : ''}
                    </div>
                </form>
            `;

            actions.innerHTML = `
                <button onclick="saveDiaryEntry()" class="btn-primary">Speichern</button>
            `;

            openPanel();
        }

        // Rezeptname automatisch in Name-Feld eintragen
        function updateDishName() {
            const recipeSelect = document.getElementById('entry-recipe');
            const dishNameInput = document.getElementById('entry-dish-name');

            if (!recipeSelect || !dishNameInput) return;

            const selectedRecipeId = recipeSelect.value;

            if (selectedRecipeId) {
                // Rezept ausgewählt - Namen eintragen
                const selectedRecipe = allRecipesForDiary.find(r => r.id == selectedRecipeId);
                if (selectedRecipe) {
                    dishNameInput.value = selectedRecipe.title;
                }
            }
            // Wenn kein Rezept ausgewählt: Feld leer lassen oder bestehenden Wert behalten
        }

        // Globale Variable für ausgewählte neue Bilder
        let selectedDiaryImages = [];
        // Globale Variable für zu entfernende existierende Bilder
        let imagesToRemove = [];

        // Hilfsfunktion: Bild komprimieren
        async function compressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Canvas erstellen
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Proportional skalieren, wenn größer als maxWidth/maxHeight
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width = width * ratio;
                            height = height * ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Bild auf Canvas zeichnen
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Als Blob mit Komprimierung exportieren
                        canvas.toBlob((blob) => {
                            // Neuen File-Objekt mit gleichem Namen erstellen
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(compressedFile);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Vorschau für mehrere Bilder
        async function previewDiaryImages(event) {
            const files = Array.from(event.target.files);

            // Bilder komprimieren
            const compressedFiles = await Promise.all(
                files.map(file => compressImage(file))
            );

            selectedDiaryImages = compressedFiles;

            const previewContainer = document.getElementById('diary-images-preview');

            // Neue Bilder hinzufügen (behalte existierende)
            compressedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.style.cssText = 'position: relative; display: flex; align-items: center; background: rgba(50, 60, 70, 0.3); border-radius: 8px; padding: 8px; max-width: 300px; margin-bottom: 10px;';
                    imageDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Vorschau" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-right: 10px;">
                        <span style="flex: 1; color: rgba(255, 255, 255, 0.7); font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
                        <button type="button" onclick="removeNewDiaryImage(${index})" style="background: linear-gradient(135deg, #FFABAB 0%, #FFC3A0 100%); color: #8b3a3a; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1; box-shadow: 0 3px 10px rgba(255, 171, 171, 0.5); transition: all 0.3s; flex-shrink: 0;">×</button>
                    `;
                    previewContainer.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });
        }

        // Entfernen eines neu ausgewählten Bildes
        function removeNewDiaryImage(index) {
            selectedDiaryImages.splice(index, 1);

            // File input zurücksetzen und neu befüllen
            const input = document.getElementById('entry-images');
            const dt = new DataTransfer();
            selectedDiaryImages.forEach(file => dt.items.add(file));
            input.files = dt.files;

            // Preview neu rendern
            const previewContainer = document.getElementById('diary-images-preview');
            const existingImages = previewContainer.querySelectorAll('img[src^="/api/uploads"]');
            previewContainer.innerHTML = '';

            // Existierende Bilder wieder hinzufügen
            existingImages.forEach(img => {
                const parent = img.parentElement.cloneNode(true);
                previewContainer.appendChild(parent);
            });

            // Neue Bilder neu rendern
            selectedDiaryImages.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.style.cssText = 'position: relative; display: flex; align-items: center; background: rgba(50, 60, 70, 0.3); border-radius: 8px; padding: 8px; max-width: 300px; margin-bottom: 10px;';
                    imageDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Vorschau" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-right: 10px;">
                        <span style="flex: 1; color: rgba(255, 255, 255, 0.7); font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
                        <button type="button" onclick="removeNewDiaryImage(${idx})" style="background: linear-gradient(135deg, #FFABAB 0%, #FFC3A0 100%); color: #8b3a3a; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1; box-shadow: 0 3px 10px rgba(255, 171, 171, 0.5); transition: all 0.3s; flex-shrink: 0;">×</button>
                    `;
                    previewContainer.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });
        }

        // Entfernen eines existierenden Bildes
        function removeExistingDiaryImage(filename) {
            imagesToRemove.push(filename);

            // Bild aus der Vorschau entfernen
            const previewContainer = document.getElementById('diary-images-preview');
            const images = previewContainer.querySelectorAll('img');
            images.forEach(img => {
                if (img.src.includes(filename)) {
                    img.parentElement.remove();
                }
            });
        }

        // Tagebucheintrag speichern
        async function saveDiaryEntry() {
            const entryId = document.getElementById('entry-id')?.value;
            const recipeId = document.getElementById('entry-recipe').value;
            const dishName = document.getElementById('entry-dish-name').value;
            const date = document.getElementById('entry-date').value;
            const notes = document.getElementById('entry-notes').value;
            const imagesInput = document.getElementById('entry-images');

            if (!date) {
                alert('Bitte gib ein Datum ein');
                return;
            }

            // Bilder hochladen (verwende selectedDiaryImages, die bereits komprimiert sind)
            const uploadedImages = [];
            if (selectedDiaryImages.length > 0) {
                for (const file of selectedDiaryImages) {
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch(`${API_BASE}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        uploadedImages.push(data.filename);
                    } catch (error) {
                        console.error('Fehler beim Hochladen:', error);
                        alert('Fehler beim Hochladen der Bilder');
                        return;
                    }
                }
            }

            // Wenn wir bearbeiten, alte Bilder behalten (außer die zu entfernenden)
            let images = uploadedImages;
            if (entryId) {
                const existingEntry = allDiaryEntries.find(e => e.id == entryId);
                if (existingEntry && existingEntry.images) {
                    // Nur die Bilder behalten, die nicht in imagesToRemove sind
                    const keepImages = existingEntry.images.filter(img => !imagesToRemove.includes(img));
                    images = [...keepImages, ...uploadedImages];
                }
            }

            const entryData = {
                recipe_id: recipeId || null,
                dish_name: dishName,
                date,
                notes,
                images
            };

            try {
                const url = entryId ? `${API_BASE}/diary/${entryId}` : `${API_BASE}/diary`;
                const method = entryId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(entryData)
                });

                if (response.ok) {
                    closePanel();
                    await loadDiaryEntries();
                } else {
                    alert('Fehler beim Speichern des Eintrags');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern des Eintrags');
            }
        }

        // Tagebucheintrag löschen
        function deleteDiaryEntry(entryId) {
            showConfirm(
                'Tagebucheintrag löschen?',
                'Diese Aktion kann nicht rückgängig gemacht werden.',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/diary/${entryId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            closePanel();
                            loadDiaryEntries();
                        } else {
                            alert('Fehler beim Löschen des Eintrags');
                        }
                    } catch (error) {
                        console.error('Fehler beim Löschen:', error);
                        alert('Fehler beim Löschen des Eintrags');
                    }
                }
            );
        }

        // Hard refresh
        function hardRefresh() {
            window.location.href = window.location.href + '?t=' + new Date().getTime();
        }
    </script>
</body>
</html>
